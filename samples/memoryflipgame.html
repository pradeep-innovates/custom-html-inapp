<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memory Flip Game</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CleverTap SDK -->
    <script
      type="text/javascript"
      src="https://d2r1yp2w7bby2u.cloudfront.net/js/clevertap.min.js"
    ></script>
    <style>
      body {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      /* Safari compatibility fixes */
      .card {
        perspective: 1000px;
        -webkit-perspective: 1000px;
        transform-style: preserve-3d;
        -webkit-transform-style: preserve-3d;
        transition: transform 0.6s;
        -webkit-transition: -webkit-transform 0.6s;
      }

      .card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
        -webkit-transform-style: preserve-3d;
        transition: transform 0.6s;
        -webkit-transition: -webkit-transform 0.6s;
      }

      .card.flipped .card-inner {
        transform: rotateY(180deg);
        -webkit-transform: rotateY(180deg);
      }

      .card-front,
      .card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .card-front {
        background: linear-gradient(45deg, #3b82f6, #2463eb);
        transform: rotateY(180deg);
        -webkit-transform: rotateY(180deg);
      }

      .card-back {
        background-color: #ec4895;
        background: linear-gradient(45deg, #ec4895, #e4589e);
        z-index: 1;
      }

      .emoji {
        font-size: 2rem;
      }

      @keyframes celebrate {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      .celebrate {
        animation: celebrate 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.8s ease-out forwards;
      }

      .coupon-container {
        display: none;
        opacity: 0;
      }

      .coupon-container.show {
        display: flex;
        animation: fadeIn 0.8s ease-out forwards;
      }

      @media (max-width: 640px) {
        .emoji {
          font-size: 1.5rem;
        }
      }

      .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 10;
      }

      .close-button:hover {
        background: #f3f4f6;
      }

      .opacity-0 {
        opacity: 0;
      }

      .shadow-xl {
        --tw-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1),
          0 8px 10px -6px rgb(0 0 0 / 0.1);
        --tw-shadow-colored: 0 20px 25px -5px var(--tw-shadow-color),
          0 8px 10px -6px var(--tw-shadow-color);
        box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000),
          var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
      }

      .transition-colors {
        transition-property: color, background-color, border-color, fill, stroke,
          -webkit-text-decoration-color;
        transition-property: color, background-color, border-color,
          text-decoration-color, fill, stroke;
        transition-property: color, background-color, border-color,
          text-decoration-color, fill, stroke, -webkit-text-decoration-color;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
      }

      .transition-opacity {
        transition-property: opacity;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
      }

      .duration-300 {
        transition-duration: 300ms;
      }

      .hover\:bg-indigo-700:hover {
        --tw-bg-opacity: 1;
        background-color: rgb(67 56 202 / var(--tw-bg-opacity, 1));
      }
    </style>
  </head>
  <body class="flex flex-col items-center justify-center p-4">
    <div
      class="bg-white bg-opacity-90 rounded-xl shadow-xl p-6 max-w-md w-full relative"
    >
      <button class="close-button" id="closeButton" onclick="closePopup()">
        ×
      </button>
      <h1 class="text-3xl font-bold text-center mb-2 text-indigo-700">
        Memory Flip
      </h1>

      <p class="text-center text-lg font-medium text-gray-700 mb-4">
        Match the Cards to Win your Prize
      </p>

      <div class="flex justify-center items-center mb-4">
        <div class="text-lg font-medium text-gray-700">
          Moves: <span id="moves">0</span>
        </div>
      </div>

      <div id="game-board" class="grid grid-cols-4 gap-2 mb-4"></div>

      <div
        id="coupon-container"
        class="coupon-container flex-col items-center justify-center py-8"
      >
        <h2 class="text-2xl font-bold text-center mb-3 text-indigo-700">
          Congratulations! 🎉
        </h2>
        <p class="text-center text-lg font-medium text-gray-700 mb-4">
          You've won a special discount!
        </p>

        <div
          class="bg-gradient-to-r from-indigo-500 to-purple-600 p-1 rounded-lg mb-4 w-full max-w-xs mx-auto"
        >
          <div
            class="bg-white rounded-md p-3 flex items-center justify-between"
          >
            <div
              class="font-mono font-bold text-xl text-indigo-700"
              id="coupon-code"
            >
              WIN
            </div>
            <button
              id="copy-btn"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-md text-sm transition-colors flex items-center"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 mr-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                ></path>
              </svg>
              Copy
            </button>
          </div>
        </div>

        <div
          id="copy-message"
          class="mt-2 text-center text-green-600 opacity-0 transition-opacity duration-300"
        >
          Copied!
        </div>
      </div>
    </div>

    <script>
      const PRIMARY_COLOR = "#2563eb"; // Blue color for text and elements v40
      const CARD_BACK_COLOR = "#ec4899"; // Pink color for card backs
      const COUPON_CODE = "WIN25OFF"; // Coupon code
      const EVENT_NAME = "GAME COMPLETED"; // CleverTap event name

      // Function to detect iOS
      function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      }

      // Function to detect Android
      function isAndroid() {
        return /Android/.test(navigator.userAgent);
      }

      // Close popup function - updated with implementation from paste1
      function closePopup() {
        console.log("Attempting to close popup");

        if (window.CleverTap) {
          CleverTap.dismissInAppNotification();
        }

        // Using the same approach as in paste1
        function closePopupFn() {
          document.location.href = "wzrk://thisleadstonowhere";
        }

        // Handle iOS specifically
        if (
          isIOS() &&
          window.webkit &&
          window.webkit.messageHandlers &&
          window.webkit.messageHandlers.clevertap
        ) {
          window.webkit.messageHandlers.clevertap.postMessage({
            action: "dismissInAppNotification",
          });
        }

        closePopupFn();
      }

      // Function to push events to CleverTap - updated with implementation from paste1
      function pushCleverTapEvent(eventName, eventProps) {
        console.log(`Pushing event: ${eventName}`, eventProps);

        // Convert eventProps to string for CleverTap
        const eventPropsStr = JSON.stringify(eventProps);

        // Handle Android
        if (window.CleverTap) {
          CleverTap.pushEvent(eventName, eventPropsStr);
        }

        // Handle iOS - using the approach from paste1
        if (
          isIOS() &&
          window.webkit &&
          window.webkit.messageHandlers &&
          window.webkit.messageHandlers.clevertap
        ) {
          // Method used in paste1
          const eventMessage = {
            action: "recordEventWithProps",
            event: eventName,
            properties: eventProps,
          };
          window.webkit.messageHandlers.clevertap.postMessage(eventMessage);
        }

        // Web SDK fallback
        if (typeof clevertap !== "undefined") {
          clevertap.event.push(eventName, eventProps);
        }
      }

      // Update user profile with multi-values - using the approach from paste1
      function setUserProfileValues(key, values) {
        console.log(`Setting profile ${key}:`, values);

        // Convert values to string format
        const valuesStr = JSON.stringify(values);

        // Handle Android
        if (window.CleverTap) {
          CleverTap.setMultiValueForKey(key, valuesStr);
        }

        // Handle iOS - using the approach from paste1
        if (
          isIOS() &&
          window.webkit &&
          window.webkit.messageHandlers &&
          window.webkit.messageHandlers.clevertap
        ) {
          const message = {
            action: "profileSetMultiValues",
            values: values,
            key: key,
          };
          window.webkit.messageHandlers.clevertap.postMessage(message);
        }

        // Web SDK fallback
        if (typeof clevertap !== "undefined") {
          const profileObj = {};
          profileObj[key] = values;
          clevertap.profile.push({ Site: profileObj });
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Initialize CleverTap if available
        if (typeof clevertap !== "undefined") {
          console.log("CleverTap web SDK initialized");
          clevertap.privacy.push({ optOut: false });
          clevertap.init("", "global");
          clevertap.setLogLevel(3);
        } else {
          console.log("CleverTap web SDK not found");
        }

        // Add dynamic styles for the colors with Safari fixes
        const styleElement = document.createElement("style");
        styleElement.textContent = `
.card-back {
background-color: ${CARD_BACK_COLOR} !important;
background: linear-gradient(45deg, ${CARD_BACK_COLOR}, ${CARD_BACK_COLOR}) !important;
}
.text-indigo-700 {
color: ${PRIMARY_COLOR} !important;
}
.bg-indigo-600, .hover\\:bg-indigo-700:hover {
background-color: ${PRIMARY_COLOR} !important;
}
.from-indigo-500 {
--tw-gradient-from: ${PRIMARY_COLOR} var(--tw-gradient-from-position);
}
`;
        document.head.appendChild(styleElement);

        const gameBoard = document.getElementById("game-board");
        const movesDisplay = document.getElementById("moves");
        const couponContainer = document.getElementById("coupon-container");
        const copyBtn = document.getElementById("copy-btn");
        const couponCode = document.getElementById("coupon-code");
        const copyMessage = document.getElementById("copy-message");

        // Set the coupon code
        couponCode.textContent = COUPON_CODE;

        // Emojis for card pairs
        const emojis = ["🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼"];

        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let canFlip = true;

        // Initialize game
        function initGame() {
          // Reset variables
          cards = [];
          flippedCards = [];
          matchedPairs = 0;
          moves = 0;
          canFlip = true;
          movesDisplay.textContent = "0";
          couponContainer.classList.remove("show");
          gameBoard.innerHTML = "";

          // Create card pairs
          const cardValues = [...emojis, ...emojis];

          // Shuffle cards
          for (let i = cardValues.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [cardValues[i], cardValues[j]] = [cardValues[j], cardValues[i]];
          }

          // Create card elements with Safari fixes
          cardValues.forEach((emoji, index) => {
            const card = document.createElement("div");
            card.className = "card aspect-square cursor-pointer";
            card.innerHTML = `
<div class="card-inner w-full h-full">
<div class="card-front">
<span class="emoji">${emoji}</span>
</div>
<div class="card-back" style="background-color: ${CARD_BACK_COLOR};">
<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
</svg>
</div>
</div>
`;

            card.dataset.value = emoji;
            card.addEventListener("click", flipCard);
            gameBoard.appendChild(card);
            cards.push(card);
          });
        }

        // Flip card function
        function flipCard() {
          if (
            !canFlip ||
            this.classList.contains("flipped") ||
            flippedCards.length >= 2
          )
            return;

          this.classList.add("flipped");
          flippedCards.push(this);

          if (flippedCards.length === 2) {
            moves++;
            movesDisplay.textContent = moves;
            canFlip = false;

            // Check for match
            if (
              flippedCards[0].dataset.value === flippedCards[1].dataset.value
            ) {
              // Match found
              flippedCards.forEach((card) => {
                setTimeout(() => {
                  card.classList.add("celebrate");
                }, 300);
              });

              matchedPairs++;
              flippedCards = [];
              canFlip = true;

              // Check for win
              if (matchedPairs === emojis.length) {
                setTimeout(() => {
                  showWinScreen();
                }, 800);
              }
            } else {
              // No match
              setTimeout(() => {
                flippedCards.forEach((card) =>
                  card.classList.remove("flipped")
                );
                flippedCards = [];
                canFlip = true;
              }, 1000);
            }
          }
        }

        // Show win screen with coupon
        async function showWinScreen() {
          // Clear the game board with a fade effect
          gameBoard.style.opacity = "0";
          gameBoard.style.height = "0";
          gameBoard.style.margin = "0";
          gameBoard.style.transition =
            "opacity 0.5s ease, height 0.5s ease, margin 0.5s ease";

          // Show the coupon container and auto-copy code
          setTimeout(async () => {
            couponContainer.classList.add("show");
            await copyToClipboard(COUPON_CODE);

            // Prepare event data
            const eventData = {
              COUPON_CODE: COUPON_CODE,
              MOVES: moves,
              TIMESTAMP: new Date().toISOString(),
            };

            // Push event to CleverTap using the updated function
            pushCleverTapEvent(EVENT_NAME, eventData);

            // Update user profile with the coupon code and moves
            setUserProfileValues("GAME_COUPON", [COUPON_CODE]);

            // Also set as regular profile property as in paste1
            const profileProps = {
              LAST_COUPON: COUPON_CODE,
              LAST_GAME_MOVES: moves,
            };

            // If web SDK is available
            if (typeof clevertap !== "undefined") {
              clevertap.profile.push({
                Site: profileProps,
              });
            }
          }, 600);
        }

        // Function to safely copy text to clipboard (Safari compatible)
        async function safeCopyToClipboard(text) {
          try {
            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(text);
              return true;
            } else {
              // Fallback for Safari
              const textArea = document.createElement("textarea");
              textArea.value = text;
              textArea.style.position = "fixed";
              textArea.style.left = "-999999px";
              textArea.style.top = "-999999px";
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();

              try {
                document.execCommand("copy");
                textArea.remove();
                return true;
              } catch (err) {
                console.error("Failed to copy: ", err);
                textArea.remove();
                return false;
              }
            }
          } catch (err) {
            console.error("Failed to copy: ", err);
            return false;
          }
        }

        // Updated copy function
        async function copyToClipboard(text) {
          const success = await safeCopyToClipboard(text);
          if (success) {
            copyMessage.style.opacity = "1";
            setTimeout(() => {
              copyMessage.style.opacity = "0";
            }, 2000);
          }
        }

        // Copy button click handler
        copyBtn.addEventListener("click", async () => {
          await copyToClipboard(couponCode.textContent);
        });

        // Initialize game on load
        initGame();
      });
    </script>
  </body>
</html>
